<!doctype html> <!-- Minimal Mistakes Jekyll Theme 4.12.0 by Michael Rose Copyright 2013-2018 Michael Rose - mademistakes.com | @mmistakes Free for personal and commercial use under the MIT license https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt --><html lang="ko" class="no-js"><head><meta charset="utf-8"> <!-- begin _includes/seo.html --><title>SQL 튜닝 - JH Blog</title><meta name="description" content="서론DBMS는 오라클 10g를 사용했습니다."><meta property="og:type" content="article"><meta property="og:locale" content="ko_KR"><meta property="og:site_name" content="JH Blog"><meta property="og:title" content="SQL 튜닝"><meta property="og:url" content="https://jehuipark.github.io/database/sql_upgrade"><meta property="og:description" content="서론DBMS는 오라클 10g를 사용했습니다."><meta property="article:published_time" content="2018-02-25T23:50:21+09:00"><meta property="fb:app_id" content="150481385751381"><link rel="canonical" href="https://jehuipark.github.io/database/sql_upgrade"> <script type="application/ld+json"> { "@context": "https://schema.org", "@type": "Person", "name": "Dev JH", "url": "https://jehuipark.github.io", "sameAs": null } </script><meta name="google-site-verification" content="googlece77ee37e1eecdba" /><meta name="naver-site-verification" content="naver4b9c5fbe228f7d5fc4264f265fee743a"> <!-- end _includes/seo.html --> <!--<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="JH Blog Feed">--><link rel="alternate" type="application/rss+xml" href="https://jehuipark.github.io/feed.xml" title="JH Blog Feed"> <!-- https://t.co/dKP3o1e --><meta name="viewport" content="width=device-width, initial-scale=1.0"> <script> document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js '; </script> <!-- For all browsers --><link rel="stylesheet" href="/assets/css/main.css"> <!--[if IE ]><style> /* old IE unsupported flexbox fixes */ .greedy-nav .site-title { padding-right: 3em; } .greedy-nav button { position: absolute; top: 0; right: 0; height: 100%; }</style><![endif]--> <script src="/assets/js/highlight.js"></script> <script src="/assets/js/highlightjs-line-numbers.min.js"></script> <!-- start custom head snippets --> <!--<link href="/assets/css/railscasts.css" rel="stylesheet" type="text/css">--><link href="/assets/css/zenburn.css" rel="stylesheet" type="text/css"> <!-- insert favicons. use https://realfavicongenerator.net/ --> <!-- end custom head snippets --><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link rel="icon" href="/favicon.ico" type="image/x-icon"></head><body class="layout--posts"> <!--[if lt IE 9]><div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]--><div class="masthead"><div class="masthead__inner-wrap"><div class="masthead__menu"><nav id="site-nav" class="greedy-nav"> <a class="site-title" href="/">JH Blog</a><ul class="visible-links"><li class="masthead__menu-item"> <a href="/about/" >about</a></li><li class="masthead__menu-item"> <a href="/categories" >category</a></li></ul><button class="search__toggle" type="button"> <span class="visually-hidden">Toggle search</span> <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16"><path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path> </svg> </button> <button class="greedy-nav__toggle hidden" type="button"> <span class="visually-hidden">토글 메뉴</span><div class="navicon"></div></button><ul class="hidden-links hidden"></ul></nav></div></div></div><div class="initial-content"><div id="main" role="main"><div class="sidebar sticky"><div itemscope itemtype="https://schema.org/Person"><div class="author__avatar"> <img src="/assets/images/me.jpg" alt="JeHui Park" itemprop="image"></div><div class="author__content"><h3 class="author__name" itemprop="name">JeHui Park</h3><p class="author__bio" itemprop="description"> 개발자 박제희</p></div><div class="author__urls-wrapper"> <button class="btn btn--inverse">팔로우</button><ul class="author__urls social-icons"><li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place"> <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Seoul, Korea</span></li><li> <a href="https://jehuipark.github.io" itemprop="url"> <i class="fas fa-fw fa-link" aria-hidden="true"></i> 웹사이트 </a></li><li> <a href="mailto:pjh2359@gmail.com"><meta itemprop="email" content="pjh2359@gmail.com" /> <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> 이메일 </a></li><li> <a href="https://github.com/JeHuiPark" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub </a></li><!--<li> <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link </a></li>--></ul></div></div></div><div class="archive"><h1 id="page-title" class="page__title">SQL 튜닝</h1><h3 id="서론">서론</h3><p><em>DBMS는 오라클 10g를 사용했습니다.</em></p><p>다음 진행하게될 A프로젝트와 현재 종료직전인 B프로젝트의 유사한점 많다는 이유로 B프로젝트에 투입되어 관리자시스템 수정 및 개선 작업을 하게 되었다. 그중 기억에 남고 재밌었던 작업을 꼽으라면 SQL 튜닝이였다. 학생때부터 디비에 관심이 있어서 DB자격증 시험을 보기도 했지만 실무에서 SQL작성은 하더라도 SQL튜닝은 해본적이 없기에 골머리 앓았던 만큼 유익한 시간이였다. (<em>그래도 나름 쿼리속도를 생각하면서 개발을 진행했었음..</em>)</p><h3 id="기존쿼리-분석">기존쿼리 분석</h3><p>관리자시스템중 API연계로그를 조회하는 기능이있는데 약 400만건의 데이터가 쌓여있었고 현재 쿼리로는 조회시간이 최소 30초이상은 걸리는 치명적인 문제가 있었기에 SQL튜닝이 필수인 상황이였다. <em>추가적으로 로그테이블을 최근2주 테이블과 히스토리테이블로 분리할 계획도 있었음</em></p><ul><li>기존 쿼리<pre><code class="language-SQL">SELECT *
FROM (
  SELECT A.*, ROWNUM AS RN
    FROM (
      SELECT API_ID,
             API_NM,
             TO_CHAR(RGST_DT, 'YYYY-MM-DD') AS RGST_DT,
             SUCCESS_YN,
             ERR_MSG
        FROM API_LOG
       ORDER BY RGST_DT DESC
    ) A
)B
 WHERE RN BETWEEN 11 AND 20;
</code></pre><p>언뜻보면 일반적인 페이징 쿼리처럼 보이지만 아주 문제가 많다. 기본적으로 데이터를 페이징하여 가져오는 이유는 조회속도를 상승시키는 데에 있을것이다. ex) <em>전체 데이터중 필요한 데이터만 조회하고 나머지 데이터는 스캔하지 않는다.</em> 위 쿼리는 <strong>데이터를 전부 조회한 후 전체범위를 정렬하여</strong>(<em>여기서 엄청난 비용이 발생</em> ) 11번째부터 20번째, 10건의 데이터만 가져오고 있다. <strong>한마디로 페이징의 기능을 상실했다.</strong></p></li></ul><h3 id="결과">결과</h3><p>이런저런 삽질을 해보니 DBMS특성상 똑같은 목적을 가지고 SQL을 작성하더라도 여러방법이 있었다.</p><ol><li>TOP-N 알고리즘 적용</li><li>인덱스 사용</li></ol><h5 id="top-n-알고리즘">TOP-N 알고리즘</h5><p>데이터의 조회 범위를 축소시켜 검색속도를 증가시켜주는 알고리즘 쉽게말하면 상위 N건의 데이터를 가져오는 방법이다.</p><p>예를 들면</p><pre><code class="language-SQL">SELECT *
  FROM A
 WHERE ROWNUM &lt;= 5;
</code></pre><p>오라클에서 데이터 조회시 제공해주는 논리순번 ROWNUM을 이용해 TOP-N알고리즘을 적용할수 있다. 위 쿼리는 A테이블에서 5건의 데이터를 조회한후 더이상 테이블을 스캔하지 않기 대문에 A테이블에 몇건의 데이터가 있던 조회속도에는 별 차이가 없을 것이다.</p><p>그런데 ORDER BY 옵션을 적용하면 약간의 문제가 생긴다 A 테이블의 데이터가 다음과 같을때</p><table><thead><tr><th style="text-align: center">COL1</th><th style="text-align: center">COL2</th></tr></thead><tbody><tr><td style="text-align: center">3</td><td style="text-align: center">TEST1</td></tr><tr><td style="text-align: center">1</td><td style="text-align: center">TEST2</td></tr><tr><td style="text-align: center">2</td><td style="text-align: center">TEST3</td></tr><tr><td style="text-align: center">4</td><td style="text-align: center">TEST4</td></tr></tbody></table><pre><code class="language-SQL">SELECT COL1, COL2, ROWNUM
  FROM A
 WHERE ROWNUM &lt;= 3
 ORDER BY COL1;
</code></pre><p>위 쿼리의 결과는 다음과 같아진다.</p><table><thead><tr><th style="text-align: center">COL1</th><th style="text-align: center">COL2</th><th style="text-align: center">ROWNUM</th></tr></thead><tbody><tr><td style="text-align: center">1</td><td style="text-align: center">TEST2</td><td style="text-align: center">2</td></tr><tr><td style="text-align: center">2</td><td style="text-align: center">TEST3</td><td style="text-align: center">3</td></tr><tr><td style="text-align: center">3</td><td style="text-align: center">TEST1</td><td style="text-align: center">1</td></tr></tbody></table><p>ROWNUM순서가 뒤죽박죽이 된걸 볼수있으며 페이징 쿼리작성시 문제가 생길거라는걸 알수 있을 대목이다. 그 이유는 먼저 FROM절에 의해 A테이블에 접근할 것이고 WHERE절에 명시된대로 ROW데이터가 걸러지며( <strong>이때 ROWNUM값 부여</strong> ) SELECT절에 의해 뷰데이터가 생성 될 것이다. 이 모든 절차가 완료된 후 정렬이 수행되기 때문에 위 쿼리로는 원하는 ROWNUM값을 가져올수 없는것이다.</p><p>해결법은 간단하다 기존쿼리를 아래처럼 한번 감싸주면 간단하게 해결된다</p><pre><code class="language-SQL">SELECT T.*, ROWNUM AS RN
  FROM (
    SELECT COL1, COL2
      FROM A
     ORDER BY COL1
  ) T
 WHERE ROWNUM &lt;= 3;
</code></pre><p>위 쿼리의 조회결과는 다음과 같다</p><table><thead><tr><th style="text-align: center">COL1</th><th style="text-align: center">COL2</th><th style="text-align: center">ROWNUM</th></tr></thead><tbody><tr><td style="text-align: center">1</td><td style="text-align: center">TEST2</td><td style="text-align: center">1</td></tr><tr><td style="text-align: center">2</td><td style="text-align: center">TEST3</td><td style="text-align: center">2</td></tr><tr><td style="text-align: center">3</td><td style="text-align: center">TEST1</td><td style="text-align: center">3</td></tr></tbody></table><p>언뜻 보면 A테이블을 풀스캔한 후 COL1을 기준으로 오름차순 정렬하여 3건의 데이터만 가져와라. 이렇게 볼수 있지만 위 쿼리는 TOP-N알고리즘이 적용되어 COL1의 정렬범위가 상위3건으로 축소되어 최저값부터 3건만 정렬후 테이블스캔이 종료되어 수행비용이 절감되는 효과를 누릴수 있다.</p><ul><li>실무적용 (<strong><em>잘못된 SQL</em></strong>)<pre><code class="language-SQL">SELECT *
FROM (
  SELECT A.*, ROWNUM AS RN
    FROM (
      SELECT API_ID,
             API_NM,
             TO_CHAR(RGST_DT, 'YYYY-MM-DD') AS RGST_DT,
             SUCCESS_YN,
             ERR_MSG
        FROM API_LOG
       ORDER BY RGST_DT DESC
    ) A
   WHERE ROWNUM &lt;= 20
)B
 WHERE RN &gt;= 11;
</code></pre><p>A뷰를 보면 RGST_DT를 기준으로 역순정렬하라고 명시한걸 볼수 있다. 하지만 앞서 설명한것처럼 ORDER BY 절에 의한 정렬은 데이터조회가 완료된후 즉, 데이터뷰를 기준으로 정렬 되기때문에 옵션값에 얼라이어스값 적용이 가능해진다. 때문에 <code class="highlighter-rouge">TO_CHAR(RGST_DT, 'YYYY-MM-DD') AS RGST_DT</code> 여기서 컬럼 얼라이어스값을 RGST_DT가아닌 다른것으로 바꿔주면 TOP-N 알고리즘이 적용되어 테이블스캔 비용시 절감되기때문에 조회시간이 훨씬 빨라진 것을 알 수있다.</p></li></ul><p class="page__taxonomy"> <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> 태그: </strong> <span itemprop="keywords"> <a href="/tags/#oracle" class="page__taxonomy-item" rel="tag">oracle</a> </span></p><a href="#page-title" class="back-to-top">Back to Top &uarr;</a><div class="page__comments"><h4 class="page__comments-title">댓글남기기</h4><section id="disqus_thread"></section></div></div></div></div><div class="search-content"><div class="search-content__inner-wrap"><input type="text" id="search" class="search-input" tabindex="-1" placeholder="검색어를 입력해주세요..." /><div id="results" class="results"></div><h4>우측 상단의 돋보기를 누르면 원래 화면으로 돌아갈 수 있습니다.</h4></div></div><div class="page__footer"><footer> <!-- start custom footer snippets --> <!-- end custom footer snippets --><div class="page__footer-follow"><ul class="social-icons"><li><strong>팔로우:</strong></li><li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> 피드</a></li></ul></div><div class="page__footer-copyright">&copy; 2019 Dev JH. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div></footer></div><script src="/assets/js/main.min.js"></script> <script defer src="https://use.fontawesome.com/releases/v5.6.0/js/all.js" integrity="sha384-z9ZOvGHHo21RqN5De4rfJMoAxYpaVoiYhuJXPyVmSs8yn20IE3PmBM534CffwSJI" crossorigin="anonymous"></script> <script src="/assets/js/lunr/lunr.min.js"></script> <script src="/assets/js/lunr/lunr-store.js"></script> <script src="/assets/js/lunr/lunr-en.js"></script> <!-- start custom analytics snippet --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-113477172-1', 'auto'); ga('send', 'pageview'); </script> <!-- end custom analytics snippet --> <script> var disqus_config = function () { this.page.url = "https://jehuipark.github.io/database/sql_upgrade"; /* Replace PAGE_URL with your page's canonical URL variable */ this.page.identifier = "/database/sql_upgrade"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */ }; (function() { /* DON'T EDIT BELOW THIS LINE */ var d = document, s = d.createElement('script'); s.src = 'https://https-jehuipark-github-io-blog.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> <script> $(document).ready(function() { $('pre code').each(function(i, block) { try{block.className = block.parentElement.parentElement.parentElement.className.split(' ')[0].replace('language-', '')}catch(e){}; hljs.highlightBlock(block); }); hljs.initLineNumbersOnLoad(); }); </script></body></html>