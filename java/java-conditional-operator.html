<!doctype html> <!-- Minimal Mistakes Jekyll Theme 4.12.0 by Michael Rose Copyright 2013-2018 Michael Rose - mademistakes.com | @mmistakes Free for personal and commercial use under the MIT license https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt --><html lang="ko" class="no-js"><head><meta charset="utf-8"> <!-- begin _includes/seo.html --><title>3항 연산자와 Unboxing 그리고 NullPointException - JH Blog</title><meta name="description" content="developer JH website."><meta property="og:type" content="article"><meta property="og:locale" content="ko_KR"><meta property="og:site_name" content="JH Blog"><meta property="og:title" content="3항 연산자와 Unboxing 그리고 NullPointException"><meta property="og:url" content="https://jehuipark.github.io/java/java-conditional-operator"><meta property="og:description" content="developer JH website."><meta property="article:published_time" content="2020-03-15T15:00:00+09:00"><meta property="fb:app_id" content="150481385751381"><link rel="canonical" href="https://jehuipark.github.io/java/java-conditional-operator"> <script type="application/ld+json"> { "@context": "https://schema.org", "@type": "Person", "name": "Dev JH", "url": "https://jehuipark.github.io", "sameAs": null } </script><meta name="google-site-verification" content="googlece77ee37e1eecdba" /><meta name="naver-site-verification" content="naver4b9c5fbe228f7d5fc4264f265fee743a"> <!-- end _includes/seo.html --> <!--<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="JH Blog Feed">--><link rel="alternate" type="application/rss+xml" href="https://jehuipark.github.io/feed.xml" title="JH Blog Feed"> <!-- https://t.co/dKP3o1e --><meta name="viewport" content="width=device-width, initial-scale=1.0"> <script> document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js '; </script> <!-- For all browsers --><link rel="stylesheet" href="/assets/css/main.css"> <!--[if IE ]><style> /* old IE unsupported flexbox fixes */ .greedy-nav .site-title { padding-right: 3em; } .greedy-nav button { position: absolute; top: 0; right: 0; height: 100%; }</style><![endif]--> <script src="/assets/js/highlight.js"></script> <script src="/assets/js/highlightjs-line-numbers.min.js"></script> <!-- start custom head snippets --> <!--<link href="/assets/css/railscasts.css" rel="stylesheet" type="text/css">--><link href="/assets/css/zenburn.css" rel="stylesheet" type="text/css"> <!-- insert favicons. use https://realfavicongenerator.net/ --> <!-- end custom head snippets --><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link rel="icon" href="/favicon.ico" type="image/x-icon"></head><body class="layout--posts"> <!--[if lt IE 9]><div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]--><div class="masthead"><div class="masthead__inner-wrap"><div class="masthead__menu"><nav id="site-nav" class="greedy-nav"> <a class="site-title" href="/">JH Blog</a><ul class="visible-links">
<li class="masthead__menu-item"> <a href="/about/">about</a>
</li>
<li class="masthead__menu-item"> <a href="/categories">category</a>
</li>
<li class="masthead__menu-item"> <a href="/tags">tag</a>
</li>
</ul>
<button class="search__toggle" type="button"> <span class="visually-hidden">Toggle search</span> <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 15.99 16"><path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path> </svg> </button> <button class="greedy-nav__toggle hidden" type="button"> <span class="visually-hidden">토글 메뉴</span><div class="navicon"></div></button><ul class="hidden-links hidden"></ul></nav></div></div></div><div class="initial-content"><div id="main" role="main">
<div class="sidebar sticky"><div itemscope itemtype="https://schema.org/Person">
<div class="author__avatar"> <img src="/assets/images/me.jpg" alt="JeHui Park" itemprop="image">
</div>
<div class="author__content">
<h3 class="author__name" itemprop="name">JeHui Park</h3>
<p class="author__bio" itemprop="description"> 개발자 박제희</p>
</div>
<div class="author__urls-wrapper"> <button class="btn btn--inverse">팔로우</button><ul class="author__urls social-icons">
<li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place"> <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Seoul, Korea</span>
</li>
<li> <a href="https://jehuipark.github.io" itemprop="url"> <i class="fas fa-fw fa-link" aria-hidden="true"></i> 웹사이트 </a>
</li>
<li> <a href="mailto:pjh2359@gmail.com"><meta itemprop="email" content="pjh2359@gmail.com"> <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> 이메일 </a>
</li>
<li> <a href="https://github.com/JeHuiPark" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub </a>
</li>
<!--<li> <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link </a></li>-->
</ul>
</div>
</div></div>
<div class="archive">
<h1 id="page-title" class="page__title">3항 연산자와 Unboxing 그리고 NullPointException</h1>
<ul id="markdown-toc">
<li>
<a href="#%EB%96%A1%EB%B0%A5" id="markdown-toc-떡밥">떡밥</a><ul>
<li>
<a href="#%EC%99%9C-nullpointexception-" id="markdown-toc-왜-nullpointexception-">왜 <code class="highlighter-rouge">NullPointException</code> ?</a><ul><li><a href="#%EC%96%B4%EB%96%BB%EA%B2%8C-%EC%95%8C%EC%95%84%EB%82%B4%EC%97%88%EB%8A%94%EA%B0%80" id="markdown-toc-어떻게-알아내었는가">어떻게 알아내었는가</a></li></ul>
</li>
<li><a href="#unboxing-%EC%9D%98-%EB%8F%99%EC%9E%91%EB%B0%A9%EC%8B%9D%EC%9D%B4-%EA%B6%81%EA%B8%88%ED%95%B4" id="markdown-toc-unboxing-의-동작방식이-궁금해"><code class="highlighter-rouge">unboxing</code> 의 동작방식이 궁금해</a></li>
</ul>
</li>
<li><a href="#%ED%9B%84%EA%B8%B0" id="markdown-toc-후기">후기</a></li>
</ul>
<h2 id="떡밥">떡밥</h2>
<p>얼마전에 팀 내에서 재밌는 이슈가 나왔다.<br> 대충 아래와 같은 방식으로 리턴하는 메소드가 존재하였는데.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Integer</span> <span class="nf">exampleMethod</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">booleanExpression</span> <span class="o">?</span> <span class="n">primitiveValue</span> <span class="o">:</span> <span class="n">integerObj</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<p><code class="highlighter-rouge">booleanExpression</code> 의 값이 <code class="highlighter-rouge">false</code> 일 때, <code class="highlighter-rouge">integerObj</code> 의 값이 <code class="highlighter-rouge">null</code> 이면 <code class="highlighter-rouge">NullPointException</code> 오류가 터지는 문제였다.</p>
<p>언뜻 보면 <code class="highlighter-rouge">booleanExpression</code> 의 값이 <code class="highlighter-rouge">false</code> 이면, <code class="highlighter-rouge">integerObj</code> 의 값이 무엇이던 그대로 반환할 것 같은 메소드이지만, 알고보면 그렇지 않다.</p>
<p>이 오류를 재현하기 위해 간단한 테스트를 작성하고, 실행 해보자</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">ex1</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">try</span> <span class="o">{</span>
    <span class="nc">Integer</span> <span class="n">a</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="nc">Integer</span> <span class="n">b</span> <span class="o">=</span> <span class="kc">false</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">a</span><span class="o">;</span>
    <span class="nc">Assert</span><span class="o">.</span><span class="na">fail</span><span class="o">();</span>
  <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">NullPointerException</span> <span class="n">expected</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"예상되는 에러"</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p><strong>테스트 결과</strong><br> <img src="https://user-images.githubusercontent.com/25237661/76698396-bb0da900-66e5-11ea-9b27-9ef98bcbdacd.png" alt="image"></p>
<h3 id="왜-nullpointexception-">왜 <code class="highlighter-rouge">NullPointException</code> ?</h3>
<p>결론부터 말하면 <code class="highlighter-rouge">java</code> 의 <code class="highlighter-rouge">unboxing</code> 과 관련된 이슈였다.</p>
<p>요악하면 변수 <code class="highlighter-rouge">a</code> 를 <code class="highlighter-rouge">unboxing</code> 하는 과정에서 <code class="highlighter-rouge">NullPointerException</code> 이 발생한다.</p>
<h4 id="어떻게-알아내었는가">어떻게 알아내었는가</h4>
<p>머릿속에 여러 생각이 들었다.</p>
<ul>
<li>
<code class="highlighter-rouge">이펙티브 자바</code> 책의 한 구절이 떠올랐다.<blockquote><p>컴파일러로 인해 개발자가 작성한 코드가 예상과 다르게 동작할 수 있다.</p></blockquote>
</li>
<li>
<code class="highlighter-rouge">NullPointerException</code> 예외가 발생할 수 있는 포인트가 3항 연산자 이외에는 보이지 않는다.</li>
<li>3항 연산자의 2항의 반환 타입이 <code class="highlighter-rouge">primitive</code> 인게 걸린다.</li>
<li>혹시 <code class="highlighter-rouge">null</code> 로 초기화 된 <code class="highlighter-rouge">a</code> 를 언박싱 하려고 하니?</li>
<li>만약 2항의 값이 <code class="highlighter-rouge">boxing object</code> 이면 에러없이 <code class="highlighter-rouge">null</code> 을 반환할까?</li>
</ul>
<p>나름의 정보를 종합하여, 한가지 가설을 세우고 바로 테스트를 작성해 보았다.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Test</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">ex2</span><span class="o">()</span> <span class="o">{</span>
  <span class="nc">Integer</span> <span class="n">a</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="nc">Integer</span> <span class="n">b</span> <span class="o">=</span> <span class="kc">false</span> <span class="o">?</span> <span class="o">(</span><span class="nc">Integer</span><span class="o">)</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">a</span><span class="o">;</span>
  <span class="nc">Assert</span><span class="o">.</span><span class="na">assertNull</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>
<p><strong>테스트 결과</strong><br> <img src="https://user-images.githubusercontent.com/25237661/76698556-bfd35c80-66e7-11ea-84cb-b4754df909f0.png" alt="image"></p>
<p><strong>내가 세운 가설</strong>은 이랬다.</p>
<ul><li>2항의 값이 <code class="highlighter-rouge">primitive</code> 이기 때문에, 3항의 <code class="highlighter-rouge">boxing object</code>가 <code class="highlighter-rouge">unboxing</code>이 되는 것은 아닐까?</li></ul>
<p>이렇게 나는 테스트 코드를 통해 이번 3항 연산자 떡밥은 <code class="highlighter-rouge">unboxing</code> 과 관련이 있다는 것이 증명 되었다고 판단하였다.</p>
<h3 id="unboxing-의-동작방식이-궁금해">
<code class="highlighter-rouge">unboxing</code> 의 동작방식이 궁금해</h3>
<p><code class="highlighter-rouge">boxing</code> 이라던지 <code class="highlighter-rouge">unboxing</code> 키워드는 정말 지겹도록 들어봤을 것이며, 이것을 설명하는 것은 주제를 넘어가니 생략한다.</p>
<p>당시에, 나는 2가지의 키워드가 의미하는 바가 무엇인지는 알고 있었지만, 솔직히 말하면 실제로 어떻게 동작하는지에 대해서는 구체적으로 알고 있는 상태는 아니였다.</p>
<p>이때의 계기로 나는 <code class="highlighter-rouge">unboxing</code> 이 어떻게 동작하는지 알아보고 싶어져서 <code class="highlighter-rouge">바이트 코드</code> 를 읽어보기로 결정하였다.</p>
<p><img src="https://user-images.githubusercontent.com/25237661/76698970-c5cb3c80-66eb-11ea-8627-85a41970551e.png" alt="image"></p>
<p>이미지에 보이는 자바코드 두줄은 바이트 코드로 이렇게 표현되고 있었다.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">L0</span>
 <span class="no">LINENUMBER</span> <span class="mi">12</span> <span class="no">L0</span>
 <span class="no">ACONST_NULL</span>
 <span class="no">ASTORE</span> <span class="mi">1</span>
<span class="no">L3</span>
 <span class="no">LINENUMBER</span> <span class="mi">13</span> <span class="no">L3</span>
 <span class="no">ALOAD</span> <span class="mi">1</span>
 <span class="no">INVOKEVIRTUAL</span> <span class="n">java</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="nc">Integer</span><span class="o">.</span><span class="na">intValue</span> <span class="o">()</span><span class="no">I</span>
 <span class="no">INVOKESTATIC</span> <span class="n">java</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="nc">Integer</span><span class="o">.</span><span class="na">valueOf</span> <span class="o">(</span><span class="no">I</span><span class="o">)</span><span class="nc">Ljava</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="nc">Integer</span><span class="o">;</span>
 <span class="no">ASTORE</span> <span class="mi">2</span>
</code></pre></div></div>
<p>천천히 순서대로 읽어보자. (<a href="https://docs.oracle.com/javase/specs/jvms/se7/html/jvms-6.html#jvms-6.5.astore">오라클 문서</a>와 같이 보면 도움이 된다.)</p>
<ol>
<li>
<code class="highlighter-rouge">LO</code> 은 자바코드 12번 라인에 대응하는 코드이다.<ol><li>
<code class="highlighter-rouge">ASTORE 1</code> -&gt; <code class="highlighter-rouge">null</code> 이라는 상수를 <code class="highlighter-rouge">로컬 참조변수 저장소</code>의 <code class="highlighter-rouge">1</code>에 저장한다.</li></ol>
</li>
<li>
<code class="highlighter-rouge">L3</code> 은 자바코드 13번 라인에 대응하는 코드이다.<ol>
<li>
<code class="highlighter-rouge">ALOAD 1</code> -&gt; <code class="highlighter-rouge">로컬 참조변수 저장소</code>의 <code class="highlighter-rouge">1</code>에서 객체를 로드 해라. (<code class="highlighter-rouge">null</code> 예상)</li>
<li>
<code class="highlighter-rouge">INVOKEVIRTUAL java/lang/Integer.intValue ()I</code> -&gt; 로드한 객체를 이용하여 <code class="highlighter-rouge">Integer</code> 클래스의 <code class="highlighter-rouge">intValue</code> 메소드를 실행해라. (<strong><code class="highlighter-rouge">null</code> 참조 상태이므로 <code class="highlighter-rouge">intValue()</code> 메소드를 실행하면 <code class="highlighter-rouge">NullPointException</code> 이 발생</strong>한다.)</li>
<li>
<code class="highlighter-rouge">INVOKESTATIC java/lang/Integer.valueOf (I)Ljava/lang/Integer</code> -&gt; <code class="highlighter-rouge">Integer</code> 클래스의 <code class="highlighter-rouge">valueOf</code>라는 정적 메소드를 실행하면서 I를 넘겨라. 정적 메소드의 반환 타입은 <code class="highlighter-rouge">java/lang/Integer</code> 이다.</li>
<li>
<code class="highlighter-rouge">ASTORE 2</code> -&gt; 반환값을 <code class="highlighter-rouge">로컬 참조변수 저장소</code>의 <code class="highlighter-rouge">2</code>에 저장하라</li>
</ol>
</li>
</ol>
<blockquote><p>바이트 코드에서 보면 13번 라인의 3항 연산자가 삭제된 것을 확인할 수 있는데, 이것은 1항의 값이 컴파일 시점에 이미 결정되어 있기 때문에 실행시점에는 2항의 값이 쓸모없는 값이 되어 버린다 그렇기 때문에, 컴파일러가 최적화한 결과라고 생각하면 되며, 이 글에서 중요하지 않는 부분이다.</p></blockquote>
<p>바이트 코드를 읽어보니 언박싱이 어떻게 동작하는 건지 알 수 있을것 같다.<br> 바이트 코드 분석중 2-2 를 확인해보면 <code class="highlighter-rouge">INVOKEVIRTUAL java/lang/Integer.intValue ()I</code> 이 부분이 박싱 객체를 언박싱하는 과정으로 보이는데, <code class="highlighter-rouge">null</code> 참조를 이용하여 <code class="highlighter-rouge">intValue()</code> 메소드를 실행하려고 시도하니 <code class="highlighter-rouge">NullPointException</code> 이 발생한 것이였다.</p>
<h2 id="후기">후기</h2>
<p>퇴근 직전에 재밌는 떡밥이였다.</p>
<ul>
<li>이 이슈는 알고보니 아주 유명한 이슈라고 한다.<ul><li>이것도 자바 스펙중 하나로 오라클에 <a href="https://docs.oracle.com/javase/specs/jls/se8/html/jls-15.html#jls-15.25">오피셜 문서</a>가 존재한다.</li></ul>
</li>
<li>3항 연산자에 박싱 객체와 언박싱 객체가 공존할 때, 언박싱 객체를 박싱객체로 변환하는 방법도 있을법 하지만, 컴파일러는 언박싱 처리를 하도록 하고 있다. 이유가 뭘까?<ul><li>그냥 단순히 객체 생성 비용을 아끼기 위해서 일까? 다른 이유가 있을까?</li></ul>
</li>
</ul>
<p class="page__taxonomy"> <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> 태그: </strong> <span itemprop="keywords"> <a href="/tags/#java" class="page__taxonomy-item" rel="tag">java</a> </span></p>
<a href="#page-title" class="back-to-top">Back to Top ↑</a><div class="page__comments">
<h4 class="page__comments-title">댓글남기기</h4>
<section id="disqus_thread"></section>
</div>
</div>
</div></div><div class="search-content"><div class="search-content__inner-wrap">
<input type="text" id="search" class="search-input" tabindex="-1" placeholder="검색어를 입력해주세요..."><div id="results" class="results"></div>
<h3>우측 상단의 돋보기를 누르면 원래 화면으로 돌아갈 수 있습니다.</h3>
</div></div><div class="page__footer"><footer> <!-- start custom footer snippets --> <!-- end custom footer snippets --><div class="page__footer-follow"><ul class="social-icons">
<li><strong>팔로우:</strong></li>
<li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> 피드</a></li>
</ul></div>
<div class="page__footer-copyright">© 2020 Dev JH. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div></footer></div><script src="/assets/js/main.min.js"></script> <script defer src="https://use.fontawesome.com/releases/v5.6.0/js/all.js" integrity="sha384-z9ZOvGHHo21RqN5De4rfJMoAxYpaVoiYhuJXPyVmSs8yn20IE3PmBM534CffwSJI" crossorigin="anonymous"></script> <script src="/assets/js/lunr/lunr.min.js"></script> <script src="/assets/js/lunr/lunr-store.js"></script> <script src="/assets/js/lunr/lunr-en.js"></script> <!-- start custom analytics snippet --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-113477172-1', 'auto'); ga('send', 'pageview'); </script> <!-- end custom analytics snippet --> <script> var disqus_config = function () { this.page.url = "https://jehuipark.github.io/java/java-conditional-operator"; /* Replace PAGE_URL with your page's canonical URL variable */ this.page.identifier = "/java/java-conditional-operator"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */ }; (function() { /* DON'T EDIT BELOW THIS LINE */ var d = document, s = d.createElement('script'); s.src = 'https://https-jehuipark-github-io-blog.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript> <script> $(document).ready(function() { $('pre code').each(function(i, block) { try{block.className = block.parentElement.parentElement.parentElement.className.split(' ')[0].replace('language-', '')}catch(e){}; hljs.highlightBlock(block); }); hljs.initLineNumbersOnLoad(); }); </script></body></html>