<!doctype html> <!-- Minimal Mistakes Jekyll Theme 4.12.0 by Michael Rose Copyright 2013-2018 Michael Rose - mademistakes.com | @mmistakes Free for personal and commercial use under the MIT license https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt --><html lang="ko" class="no-js"><head><meta charset="utf-8"> <!-- begin _includes/seo.html --><title>JPA 에서 UUID 사용할 때 주의할 점 - JH Blog</title><meta name="description" content="developer JH website."><meta property="og:type" content="article"><meta property="og:locale" content="ko_KR"><meta property="og:site_name" content="JH Blog"><meta property="og:title" content="JPA 에서 UUID 사용할 때 주의할 점"><meta property="og:url" content="https://jehuipark.github.io/java/my-sql-binary-reference"><meta property="og:description" content="developer JH website."><meta property="article:published_time" content="2020-03-28T22:00:00+09:00"><meta property="fb:app_id" content="150481385751381"><link rel="canonical" href="https://jehuipark.github.io/java/my-sql-binary-reference"> <script type="application/ld+json"> { "@context": "https://schema.org", "@type": "Person", "name": "Dev JH", "url": "https://jehuipark.github.io", "sameAs": null } </script><meta name="google-site-verification" content="googlece77ee37e1eecdba" /><meta name="naver-site-verification" content="naver4b9c5fbe228f7d5fc4264f265fee743a"> <!-- end _includes/seo.html --> <!--<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="JH Blog Feed">--><link rel="alternate" type="application/rss+xml" href="https://jehuipark.github.io/feed.xml" title="JH Blog Feed"> <!-- https://t.co/dKP3o1e --><meta name="viewport" content="width=device-width, initial-scale=1.0"> <script> document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js '; </script> <!-- For all browsers --><link rel="stylesheet" href="/assets/css/main.css"> <!--[if IE ]><style> /* old IE unsupported flexbox fixes */ .greedy-nav .site-title { padding-right: 3em; } .greedy-nav button { position: absolute; top: 0; right: 0; height: 100%; }</style><![endif]--> <script src="/assets/js/highlight.js"></script> <script src="/assets/js/highlightjs-line-numbers.min.js"></script> <!-- start custom head snippets --> <!--<link href="/assets/css/railscasts.css" rel="stylesheet" type="text/css">--><link href="/assets/css/zenburn.css" rel="stylesheet" type="text/css"> <!-- insert favicons. use https://realfavicongenerator.net/ --> <!-- end custom head snippets --><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link rel="icon" href="/favicon.ico" type="image/x-icon"></head><body class="layout--posts"> <!--[if lt IE 9]><div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]--><div class="masthead"><div class="masthead__inner-wrap"><div class="masthead__menu"><nav id="site-nav" class="greedy-nav"> <a class="site-title" href="/">JH Blog</a><ul class="visible-links">
<li class="masthead__menu-item"> <a href="/about/">about</a>
</li>
<li class="masthead__menu-item"> <a href="/categories">category</a>
</li>
<li class="masthead__menu-item"> <a href="/tags">tag</a>
</li>
</ul>
<button class="search__toggle" type="button"> <span class="visually-hidden">Toggle search</span> <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewbox="0 0 15.99 16"><path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path> </svg> </button> <button class="greedy-nav__toggle hidden" type="button"> <span class="visually-hidden">토글 메뉴</span><div class="navicon"></div></button><ul class="hidden-links hidden"></ul></nav></div></div></div><div class="initial-content"><div id="main" role="main">
<div class="sidebar sticky"><div itemscope itemtype="https://schema.org/Person">
<div class="author__avatar"> <img src="/assets/images/me.jpg" alt="JeHui Park" itemprop="image">
</div>
<div class="author__content">
<h3 class="author__name" itemprop="name">JeHui Park</h3>
<p class="author__bio" itemprop="description"> 개발자 박제희</p>
</div>
<div class="author__urls-wrapper"> <button class="btn btn--inverse">팔로우</button><ul class="author__urls social-icons">
<li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place"> <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Seoul, Korea</span>
</li>
<li> <a href="https://jehuipark.github.io" itemprop="url"> <i class="fas fa-fw fa-link" aria-hidden="true"></i> 웹사이트 </a>
</li>
<li> <a href="mailto:pjh2359@gmail.com"><meta itemprop="email" content="pjh2359@gmail.com"> <i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i> 이메일 </a>
</li>
<li> <a href="https://github.com/JeHuiPark" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub </a>
</li>
<!--<li> <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer"> <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link </a></li>-->
</ul>
</div>
</div></div>
<div class="archive">
<h1 id="page-title" class="page__title">JPA 에서 UUID 사용할 때 주의할 점</h1>
<ul id="markdown-toc">
<li>
<a href="#uuid%EB%A1%9C-%EC%A1%B0%ED%9A%8C%EA%B0%80-%EC%95%88%EB%90%9C%EB%8B%A4" id="markdown-toc-uuid로-조회가-안된다">UUID로 조회가 안된다.</a><ul>
<li><a href="#%ED%98%BC%EB%9E%80%EC%9D%B4-%EC%98%A8%EB%8B%A4" id="markdown-toc-혼란이-온다">혼란이 온다.</a></li>
<li><a href="#%EC%84%B1%EA%B3%B5%EC%A0%81%EC%9D%B8-%EA%B5%AC%EA%B8%80%EB%A7%81" id="markdown-toc-성공적인-구글링">성공적인 구글링</a></li>
</ul>
</li>
<li>
<a href="#%EC%99%9C-%EA%B7%B8%EB%9F%B4%EA%B9%8C" id="markdown-toc-왜-그럴까">왜 그럴까?</a><ul>
<li><a href="#%ED%95%9C%EC%A4%84-%EC%9A%94%EC%95%BD" id="markdown-toc-한줄-요약">한줄 요약</a></li>
<li><a href="#%ED%99%95%EC%9D%B8-%ED%95%B4%EB%B3%B4%EC%9E%90" id="markdown-toc-확인-해보자">확인 해보자</a></li>
</ul>
</li>
</ul>
<h2 id="uuid로-조회가-안된다">UUID로 조회가 안된다.</h2>
<p>최근에 엔티티를 만들면서 <code class="highlighter-rouge">Id</code> 컬럼의 타입을 UUID 로 지정하면서 경험했던 이슈가 있다.</p>
<p>평소처럼 엔티티를 클래스를 작성하고, 기본적인 비즈니스 로직(1번 로직)을 구현하고, 비즈니스 로직에 대응하는 TC 를 작성하고 문제없이 동작하는 것을 확인한 후에 나는 다음 비즈니스 로직(2번 로직)을 구현하였다.</p>
<p>그런데, 다음 비즈니스 로직을 구현하고 검증하는 과정에서 문제가 발생했다.</p>
<p>2번 로직은 요약하면 이런 구성이였다.</p>
<ol>
<li>UUID 값을 전달받는다.<ol><li>UUID 값이 없다면 <code class="highlighter-rouge">Exception</code> 을 <code class="highlighter-rouge">throw</code> 한다.</li></ol>
</li>
<li>UUID 값을 이용해 조회후 값을 변경한다.</li>
</ol>
<p>검증하는 과정에서는 정상적인 컨텍스트에서 실행을 했기 때문에 이 메소드는 예외를 발생시키지 않고 정상 리턴되야 했는데 이상하게 UUID 값이 없다는 예외를 발생시키고 있엇다.</p>
<h3 id="혼란이-온다">혼란이 온다.</h3>
<p>원인 파악을 위해 2번째 로직을 작성하기 전에 1번째 로직과 1번째 로직을 검증하는 TC 를 찬찬히 살펴보았다.<br> 이상하게도 1번째 로직과 TC 에는 아무런 문제가 없었고, 혹시나 하는 마음에 TC 의 검증로직을 다르게 작성해보기도 했지만, 당연하게도 테스트 검증결과에는 녹색불이 들어왔다.</p>
<p>다만, 1번 로직과 2번로직을 검증하는 환경에는 한 가지 차이점이 존재했다</p>
<ul>
<li>
<strong>1번 로직을 테스트할 때는 H2 인메모리 데이터베이스</strong>를 사용했다</li>
<li>
<strong>2번 로직을 테스할 때는 개발 데이터베이스</strong>를 사용했다</li>
</ul>
<h3 id="성공적인-구글링">성공적인 구글링</h3>
<p>혹시나 해서 구글링을 해보니 <a href="https://phauer.com/2016/uuids-hibernate-mysql/">이런 글</a>을 확인할 수 있었고, 중간에 몇 가지 문구가 눈에 들어왔다.<br> “<em>UUID 에는 16 바이트가 필요합니다</em>”<br> “<em>UUID 를 저장할 땐 <code class="highlighter-rouge">VARCHAR</code> 대신 <code class="highlighter-rouge">BINARY(16)</code> 컬럼을 이용하세요</em>”</p>
<p>그리고 개발 데이터베이스를 확인해보니 UUID 를 저장하는 컬럼이 <code class="highlighter-rouge">BINARY(255)</code> 으로 설정된 것을 확인할 수 있었다.</p>
<blockquote><p><a href="https://phauer.com/2016/uuids-hibernate-mysql/">이 글</a>에서 전하고자 하는 내용의 주제가 내가 필요로 하는 주제는 아니였지만, 문구 하나가 나에게는 많은 도움이 되었다.</p></blockquote>
<p>일단 테이블 컬럼을 직접 수정하는 방법도 있지만, 개발 단계이기 때문에(?) 그냥 테이블을 삭제시켜 버리고 <code class="highlighter-rouge">Entity</code> 클래스의 메타정보를 수정하기로 결정하였다. (그게 더 깔끔하다고 판단)</p>
<p><strong>수정전</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Example</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">generator</span> <span class="o">=</span> <span class="s">"uuid2"</span><span class="o">)</span>
  <span class="nd">@GenericGenerator</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"uuid2"</span><span class="o">,</span> <span class="n">strategy</span> <span class="o">=</span> <span class="s">"uuid2"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="no">UUID</span> <span class="n">id</span><span class="o">;</span>

  <span class="c1">// ...</span>
<span class="o">}</span>
</code></pre></div></div>
<p><strong>수정후</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="kd">class</span> <span class="nc">Example</span> <span class="o">{</span>
  <span class="nd">@Id</span>
  <span class="nd">@GeneratedValue</span><span class="o">(</span><span class="n">generator</span> <span class="o">=</span> <span class="s">"uuid2"</span><span class="o">)</span>
  <span class="nd">@GenericGenerator</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"uuid2"</span><span class="o">,</span> <span class="n">strategy</span> <span class="o">=</span> <span class="s">"uuid2"</span><span class="o">)</span>
  <span class="nd">@Column</span><span class="o">(</span><span class="n">columnDefinition</span> <span class="o">=</span> <span class="s">"BINARY(16)"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="no">UUID</span> <span class="n">id</span><span class="o">;</span>

  <span class="c1">// ...</span>
<span class="o">}</span>
</code></pre></div></div>
<p>수정후 2번 로직을 테스트해보니 예상하던 결과가 떨어지는 것을 확인할 수 있었다.</p>
<p>1번 로직을 구현하고 테스트하는 시점에 이 문제를 알았다면, 더 좋았을텐데 라는 생각이 든다. 나는 이 문제를 <code class="highlighter-rouge">binary</code> 타입을 처리하는 DBMS의 차이(H2와 MySQL)로 이런 결과가 생긴것이라고 <strong>추측</strong>하고 있다.</p>
<h2 id="왜-그럴까">왜 그럴까?</h2>
<p>해결은 했지만, 이렇게 두리뭉술하게 넘어가기엔 너무 찝찝하다. 그래서 자료조사를 조금 더 해보았고, <a href="https://dev.mysql.com/doc/refman/8.0/en/binary-varbinary.html">오피셜 문서</a>를 발견하였다.</p>
<p><img src="https://user-images.githubusercontent.com/25237661/77825064-49544700-714a-11ea-98bb-6298edda3a10.png" alt="image"></p>
<h3 id="한줄-요약">한줄 요약</h3>
<p>저장할 때 남는 길이는 <code class="highlighter-rouge">RPAD</code> 처리하고 저장한다. (아 이래서 조회를 못한거구나?)</p>
<h3 id="확인-해보자">확인 해보자</h3>
<ol>
<li>검증을 위해 (잘못된?) 테이블을 생성하자<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">create</span> <span class="k">table</span> <span class="k">temp</span> <span class="p">(</span>
  <span class="n">id</span> <span class="nb">BINARY</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="k">PRIMARY</span> <span class="k">KEY</span>
<span class="p">)</span>
</code></pre></div></div>
</li>
<li>테스트용 데이터를 만들자.<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="n">uuid</span><span class="p">();</span>
</code></pre></div></div>
<p><code class="highlighter-rouge">8f886d50-70ff-11ea-b498-02dd0a2dce82</code> 라는 <code class="highlighter-rouge">UUID</code> 를 생성했다.</p>
</li>
<li>UUID의 길이를 확인해보자.<br> UUID의 길이는 16바이트의 길이를 요구한다고 하였다. 눈으로 직접 확인해보자<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">select</span> <span class="k">length</span><span class="p">(</span><span class="n">unhex</span><span class="p">(</span><span class="k">replace</span><span class="p">(</span><span class="s1">'8f886d50-70ff-11ea-b498-02dd0a2dce82'</span><span class="p">,</span><span class="s1">'-'</span><span class="p">,</span><span class="s1">''</span><span class="p">)))</span>
</code></pre></div></div>
<p><img src="https://user-images.githubusercontent.com/25237661/77825438-acdf7400-714c-11ea-9fae-955273b19a67.png" alt="image"><br> <br> 약속대로 16 이라는 길이가 나온다.</p>
</li>
<li>데이터를 저장해보자<br> <code class="highlighter-rouge">MySQL</code> 에서 가이드 하는대로 <code class="highlighter-rouge">-</code> 를 공백으로 치환하고 <code class="highlighter-rouge">binary</code> 타입으로 변경하여 데이터를 밀어 넣자.<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">insert</span> <span class="k">into</span> <span class="k">temp</span> 
<span class="k">values</span> <span class="p">(</span><span class="n">unhex</span><span class="p">(</span><span class="k">replace</span><span class="p">(</span><span class="s1">'8f886d50-70ff-11ea-b498-02dd0a2dce82'</span><span class="p">,</span><span class="s1">'-'</span><span class="p">,</span><span class="s1">''</span><span class="p">)));</span>
</code></pre></div></div>
</li>
<li>조회를 해보자<br> 레퍼런스에서는 남는 공간은 패딩처리 한다고 했다.<br> 그러니까 나는 16바이트의 길이를 가진 데이터를 저장했지만, 실제로는 255 길이를 소유한 데이터가 있어야 한다.<br> <br> 그걸 눈으로 확인하기 위해 아래와 같은 쿼리를 날렸다.<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">select</span> <span class="k">length</span><span class="p">(</span><span class="n">id</span><span class="p">),</span> <span class="n">hex</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
   <span class="k">from</span> <span class="k">temp</span><span class="p">;</span>
</code></pre></div></div>
<p><img src="https://user-images.githubusercontent.com/25237661/77825566-6fc7b180-714d-11ea-8b53-c417115a261a.png" alt="image"><br> <br></p>
<p>레퍼런스에서 설명한대로 우측에 패딩값이 들어간 것을 확인할 수 있다.<br> 미리 생성해둔 UUID 로 조회를 시도해보자</p>
<blockquote><p>내가 경험한 이슈를 흉내낸 것이다</p></blockquote>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">select</span> <span class="o">*</span>
   <span class="k">from</span> <span class="k">temp</span>
 <span class="k">where</span> <span class="n">id</span> <span class="o">=</span> <span class="n">unhex</span><span class="p">(</span><span class="k">replace</span><span class="p">(</span><span class="s1">'8f886d50-70ff-11ea-b498-02dd0a2dce82'</span><span class="p">,</span><span class="s1">'-'</span><span class="p">,</span><span class="s1">''</span><span class="p">));</span>
</code></pre></div></div>
<p>조회가 안된다.<br> 패딩값 때문에 당연한 결과일 것이다. <br> <strong>그렇다면 조회조건에 패딩값을 포함하면 조회가 되야 되겠지?</strong></p>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">select</span> <span class="n">hex</span><span class="p">(</span><span class="n">SUBSTR</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span> <span class="k">AS</span> <span class="n">origin_uuid</span>
   <span class="k">from</span> <span class="k">temp</span>
 <span class="k">where</span> <span class="n">id</span> <span class="o">=</span> <span class="n">rpad</span><span class="p">(</span><span class="n">unhex</span><span class="p">(</span><span class="k">replace</span><span class="p">(</span><span class="s1">'8f886d50-70ff-11ea-b498-02dd0a2dce82'</span><span class="p">,</span><span class="s1">'-'</span><span class="p">,</span><span class="s1">''</span><span class="p">)),</span> <span class="mi">255</span><span class="p">,</span> <span class="s1">'</span><span class="se">\0</span><span class="s1">'</span><span class="p">);</span>
</code></pre></div></div>
<p>예상대로 조회가 되는 것을 확인할 수 있다.<br> <img src="https://user-images.githubusercontent.com/25237661/77825850-47d94d80-714f-11ea-94f2-4068c05b2f1e.png" alt="image"></p>
</li>
</ol>
<p class="page__taxonomy"> <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> 태그: </strong> <span itemprop="keywords"> <a href="/tags/#mysql" class="page__taxonomy-item" rel="tag">mysql</a><span class="sep">, </span> <a href="/tags/#uuid" class="page__taxonomy-item" rel="tag">uuid</a> </span></p>
<a href="#page-title" class="back-to-top">Back to Top ↑</a><div class="page__comments">
<h4 class="page__comments-title">댓글남기기</h4>
<section id="disqus_thread"></section>
</div>
</div>
</div></div><div class="search-content"><div class="search-content__inner-wrap">
<input type="text" id="search" class="search-input" tabindex="-1" placeholder="검색어를 입력해주세요..."><div id="results" class="results"></div>
<h3>우측 상단의 돋보기를 누르면 원래 화면으로 돌아갈 수 있습니다.</h3>
</div></div><div class="page__footer"><footer> <!-- start custom footer snippets --> <!-- end custom footer snippets --><div class="page__footer-follow"><ul class="social-icons">
<li><strong>팔로우:</strong></li>
<li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> 피드</a></li>
</ul></div>
<div class="page__footer-copyright">© 2020 Dev JH. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div></footer></div><script src="/assets/js/main.min.js"></script> <script defer src="https://use.fontawesome.com/releases/v5.6.0/js/all.js" integrity="sha384-z9ZOvGHHo21RqN5De4rfJMoAxYpaVoiYhuJXPyVmSs8yn20IE3PmBM534CffwSJI" crossorigin="anonymous"></script> <script src="/assets/js/lunr/lunr.min.js"></script> <script src="/assets/js/lunr/lunr-store.js"></script> <script src="/assets/js/lunr/lunr-en.js"></script> <!-- start custom analytics snippet --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-113477172-1', 'auto'); ga('send', 'pageview'); </script> <!-- end custom analytics snippet --> <script> var disqus_config = function () { this.page.url = "https://jehuipark.github.io/java/my-sql-binary-reference"; /* Replace PAGE_URL with your page's canonical URL variable */ this.page.identifier = "/java/my-sql-binary-reference"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */ }; (function() { /* DON'T EDIT BELOW THIS LINE */ var d = document, s = d.createElement('script'); s.src = 'https://https-jehuipark-github-io-blog.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript> <script> $(document).ready(function() { $('pre code').each(function(i, block) { try{block.className = block.parentElement.parentElement.parentElement.className.split(' ')[0].replace('language-', '')}catch(e){}; hljs.highlightBlock(block); }); hljs.initLineNumbersOnLoad(); }); </script></body></html>