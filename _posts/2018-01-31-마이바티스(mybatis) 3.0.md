---
layout: post
title:  "마이바티스(mybatis) 옵션"
date:   2018-01-31 17:59:21 +0700
categories: spring 스프링 oracle 오라클
---

- ### insert, update, delete 요청에서 selectKey추출

```xml
<insert id="id" parameterType="HashMap" >
  <selectKey keyProperty="seq" resultType="Integer" order="BEFORE">
    (SELECT SEQUNCE_NAME.NEXTVAL FROM DUAL)
  </selectKey>
  INSERT INTO TABLE_NAME
  VALUES(#{seq}, #{data})
</insert>
```
###### serviceImpl.java
```java
reqMap.get("seq") // null
dao.insert(id, reqMap);
reqMap.get("seq") // SEQUNCE_NAME.NEXTVAL  
```
<br><br>

- ### 반복문  

```xml
<delete id="id" parameterType="HashMap">
DELETE TABLE_NAME WHERE COL = #{key}
<if test="cttNums != null ">
    <foreach collection="cttNums"  item="item" separator="," open="AND CTT_NUM NOT IN (" close=")">#{item}</foreach>
 </if>
</delete>
```

----
<br>

### 마이바티스 이슈

#### 1. sqlmap에서 if옵션을 사용해 분기처리를 하는부분이 있는데 의도한대로 분기처리가 되지 않았다.
> ##### 문제의 sqlmap
```xml
<select id="...." parameterType="HashMap" resultType="egovMap">
    SELECT
....
  FROM ....
WHERE .... = #{....}
AND DEL_FLAGE = 'N'
    <if test="fileTy == '5'">
          AND LOAN_FILE_TYPE &lt; '6'
    </if>
    <if test="fileTy == '6'">
          AND LOAN_FILE_TYPE = #{fileTy}
    </if>
ORDER BY ....
</select>
```
> ###### 해결 과정
> 1. 파라미터 확인
> <br>
> 2. 파라미터 타입 확인
>     1. `java reqMap.get("fileTy") instanceof String` 결과 `TRUE`
>     2. `java reqMap.get("fileTy") instanceof Integer` 결과 `FALSE`  
> <br>
> 1. 혹시 마이바티스에서 밸류값에 따라 자료형을 재정의하지 않을까 ??
>     1. sqlmap 소스변경 기존 `xml <if test="fileTy == '5'">` 이부분에서 싱글쿼테이션을 제거하여 정수형으로 변경 `xml <if test="fileTy == 5 ">`
>
>**완료**
